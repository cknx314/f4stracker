<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fee-for-Service Fund Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#16A34A">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: '0 20px 60px -20px rgba(0,0,0,0.45)',
            glow: '0 0 0 2px rgba(34,197,94,0.35), 0 15px 45px -10px rgba(34,197,94,0.45)'
          },
          animation: {
            pulseonce: 'pulseonce 700ms ease-out 1',
            glowloop: 'glowloop 4s ease-in-out infinite'
          },
          keyframes: {
            pulseonce: {
              '0%': { transform: 'scale(1)', opacity: '0' },
              '40%': { transform: 'scale(1.06)', opacity: '1' },
              '100%': { transform: 'scale(1)', opacity: '0' },
            },
            glowloop: {
              '0%,100%': { boxShadow: '0 0 0 0 rgba(167,243,208,0.25), 0 10px 30px -10px rgba(34,197,94,0.55)' },
              '50%': { boxShadow: '0 0 0 4px rgba(167,243,208,0.25), 0 30px 80px -20px rgba(34,197,94,0.55)' }
            }
          }
        }
      }
    }
  </script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --primary:#16A34A; --secondary:#34D399; --accent:#A7F3D0;
      --ring:#22C55E; --bg:#071A13; --text:#EAFDF5;
      --panel: rgba(255,255,255,0.04); --panel-border: rgba(255,255,255,0.08);
      --muted: rgba(255,255,255,0.6); --muted2: rgba(255,255,255,0.4);
      --header: rgba(7,26,19,0.75);
    }
    body.theme-light{
      --primary:#0077C8; --secondary:#7EC8F8; --accent:#DFF4FF; --ring:#3BA1F2;
      --bg:#F7FBFF; --text:#0b1f18; --panel: rgba(0,0,0,0.03);
      --panel-border: rgba(0,0,0,0.08); --muted: rgba(0,0,0,0.6);
      --muted2: rgba(0,0,0,0.4); --header: rgba(255,255,255,0.8);
    }
    body{
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(34,197,94,0.20), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(52,211,153,0.18), transparent 55%),
        radial-gradient(1200px 900px at 50% 120%, rgba(22,163,74,0.12), transparent 60%),
        linear-gradient(180deg, #0b251c 0%, #0a1f18 60%, var(--bg) 100%);
      color: var(--text); min-height: 100vh; transition: background 200ms ease, color 200ms ease;
    }
    body.theme-light{
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(0,119,200,0.10), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(126,200,248,0.12), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, #F7FBFF 100%);
    }
    .glass { background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.02)); border: 1px solid var(--panel-border); backdrop-filter: blur(10px); transition: background 200ms ease, border-color 200ms ease; }
    :focus{ outline:none; } .focus-visible{ box-shadow: 0 0 0 3px rgba(167,243,208,.65) !important; }
    body.modal-open{ overflow: hidden; } .ring-progress{ transition: stroke-dashoffset 300ms ease, stroke 300ms ease; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur border-b border-white/10" style="background: var(--header);">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-[var(--primary)] grid place-items-center text-white font-bold shadow-glow">FF</div>
        <div>
          <h1 class="text-lg sm:text-xl font-semibold leading-tight">Fee-for-Service Fund Tracker</h1>
          <p class="text-xs" style="color:var(--muted)">LocalStorage/IndexedDB â€¢ No server required</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <label class="inline-flex items-center gap-2 text-sm" style="color:var(--text)" title="Loads a few example customers for testing">
          <input id="demoToggle" type="checkbox" class="h-4 w-4 accent-[var(--primary)]" />
          <span>Load Demo Data</span>
        </label>
        <button id="btnAllDonorsPdf" class="px-3 py-2 rounded-xl bg-[var(--primary)] text-white text-sm hover:opacity-90 shadow-glow">Export All Customers PDF</button>
        <button id="btnTheme" class="px-3 py-2 rounded--xl border text-sm hover:opacity-90" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Toggle Theme</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-4 grid lg:grid-cols-3 gap-6">
    <!-- Goal + Ring -->
    <section class="lg:col-span-1">
      <div class="glass rounded-2xl p-5 shadow-soft">
        <h2 class="font-semibold text-lg mb-3">Campaign Goal</h2>
        <div class="flex items-start gap-4">
          <div class="shrink-0">
            <svg width="140" height="140" viewBox="0 0 120 120" class="block animate-glowloop rounded-full" aria-hidden="true">
              <circle cx="60" cy="60" r="54" stroke="rgba(255,255,255,0.12)" stroke-width="12" fill="none"></circle>
              <circle id="ringProgress" cx="60" cy="60" r="54" stroke="var(--ring)" stroke-linecap="round" stroke-width="12" fill="none" class="ring-progress" stroke-dasharray="339.292" stroke-dashoffset="339.292"></circle>
              <g id="ringBadge" class="hidden">
                <rect x="64" y="6" rx="8" ry="8" width="50" height="26" fill="var(--primary)" opacity="0.95"></rect>
                <text x="89" y="24" font-size="10" text-anchor="middle" fill="#EAFDF5" font-weight="700">Goal Reached!</text>
              </g>
            </svg>
          </div>
          <div class="grow">
            <label for="goalInput" class="block text-sm" style="color:var(--muted)">Goal Amount ($)</label>
            <input id="goalInput" type="number" min="0" step="0.01" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)" placeholder="e.g. 5000" />
            <p class="text-xs mt-1" style="color:var(--muted)">Saved automatically.</p>
            <div class="mt-4">
              <div class="text-2xl font-bold" id="raisedText">$0.00</div>
              <div class="text-sm" id="percentText" style="color:var(--muted)">0% of $0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="glass rounded-2xl p-5 shadow-soft mt-6">
        <h2 class="font-semibold text-lg">Settings & Data</h2>

        <!-- PDF Logo controls -->
        <div class="mt-2 p-3 rounded-2xl border" style="border-color:var(--panel-border); background:var(--panel)">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="text-sm">
              <div class="font-medium">Set PDF Logo</div>
              <div class="" style="color:var(--muted)">Logo will appear centered at the top of every PDF.</div>
            </div>
            <div class="flex items-center gap-2">
              <label class="px-3 py-2 rounded-2xl text-sm cursor-pointer hover:opacity-90 border" style="background:transparent; border-color:var(--panel-border); color:var(--text)">
                Choose Image
                <input id="logoUpload" type="file" accept="image/*" class="hidden" />
              </label>
              <button id="btnClearLogo" class="px-3 py-2 rounded-2xl border hover:opacity-90" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Clear</button>
            </div>
          </div>
          <div class="mt-3 flex items-center gap-3">
            <img id="logoPreview" alt="Logo preview" class="h-10 hidden rounded bg-white/80 p-1" />
            <div id="logoStatus" class="text-xs" style="color:var(--muted)">No logo set.</div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 gap-2">
          <div class="flex gap-2 flex-wrap">
            <button id="btnExportCsv" class="px-3 py-2 rounded-2xl text-sm hover:opacity-90 border" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Export CSV (Filtered)</button>
            <label class="px-3 py-2 rounded-2xl text-sm cursor-pointer hover:opacity-90 border" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Import CSV<input id="importCsv" type="file" accept=".csv" class="hidden" /></label>
            <button id="btnBackupJson" class="px-3 py-2 rounded-2xl text-sm hover:opacity-90 border" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Backup JSON</button>
            <label class="px-3 py-2 rounded-2xl text-sm cursor-pointer hover:opacity-90 border" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Restore JSON<input id="restoreJson" type="file" accept=".json" class="hidden" /></label>
          </div>
          <div class="mt-3">
            <button id="btnReset" class="px-3 py-2 rounded-2xl bg-red-600 text-white text-sm">Reset App</button>
            <p class="text-xs mt-1" style="color:var(--muted)">Type <span class="font-mono font-semibold">RESET</span> in the prompt to confirm.</p>
          </div>
          <div id="importSummary" class="text-sm mt-2 hidden" role="status" aria-live="polite" style="color:var(--text)"></div>
        </div>
      </div>
    </section>

    <!-- Customers -->
    <section class="lg:col-span-2">
      <div class="glass rounded-2xl p-5 shadow-soft">
        <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="font-semibold text-lg">Customers</h2>
          <div class="flex gap-2">
            <div class="relative">
              <input id="searchInput" type="text" placeholder="Search company, contact, or email" class="w-64 max-w-full rounded-2xl border border-white/15 bg-white/5 pl-9 pr-3 py-2" style="color:var(--text)" aria-label="Search customers" />
              <svg class="w-5 h-5 absolute left-2 top-2.5" style="color:var(--muted2)" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 103.75 3.75a7.5 7.5 0 0012.9 12.9z"></path></svg>
            </div>
            <button id="btnAddDonor" class="px-3 py-2 rounded-2xl bg-[var(--secondary)] text-[#04130e] text-sm font-semibold hover:opacity-90 shadow-glow">Add Customer</button>
          </div>
        </div>

        <!-- Status filters -->
        <div id="statusFilters" class="flex flex-wrap gap-2 mt-3">
          <button data-sf="all" class="px-2 py-1 rounded-lg border border-white/15 bg-transparent">All</button>
          <button data-sf="Paid" class="px-2 py-1 rounded-lg border border-white/15 bg-transparent">Paid</button>
          <button data-sf="Pledged" class="px-2 py-1 rounded-lg border border-white/15 bg-transparent">Pledged</button>
          <button data-sf="Invoiced" class="px-2 py-1 rounded-lg border border-white/15 bg-transparent">Invoiced</button>
        </div>

        <!-- Date filters -->
        <div id="dateFilters" class="flex flex-wrap gap-2 mt-3">
          <button data-df="all" class="px-2 py-1 rounded-lg border border-white/15 bg-transparent">All Time</button>
          <button data-df="this_month" class="px-2 py-1 rounded-lg border border-white/15 bg-transparent">This Month</button>
          <button data-df="last_month" class="px-2 py-1 rounded-lg border border-white/15 bg-transparent">Last Month</button>
          <button data-df="ytd" class="px-2 py-1 rounded-lg border border-white/15 bg-transparent">YTD</button>
        </div>

        <div class="overflow-x-auto mt-4" role="region" aria-label="Customer table region">
          <table class="min-w-full text-sm" aria-describedby="tableDesc">
            <caption id="tableDesc" class="sr-only">Columns: Company, Contact, Phone, Email, Amount, Date, Status, Actions. Sort by Company or Amount.</caption>
            <thead>
              <tr class="text-left border-b border-white/10" style="color:var(--muted)">
                <th class="px-3 py-2 cursor-pointer select-none" id="thCompany">Company <span class="opacity-60" id="iconSortCompany">â‡…</span></th>
                <th class="px-3 py-2">Contact</th>
                <th class="px-3 py-2">Phone</th>
                <th class="px-3 py-2">Email</th>
                <th class="px-3 py-2 cursor-pointer select-none" id="thAmount">Amount <span class="opacity-60" id="iconSortAmount">â‡…</span></th>
                <th class="px-3 py-2">Date</th>
                <th class="px-3 py-2">Status</th>
                <th class="px-3 py-2">Actions</th>
              </tr>
            </thead>
            <tbody id="donorTbody" class="align-top"></tbody>
          </table>
        </div>

        <div id="subtotalBar" class="mt-3 text-sm" style="color:var(--text)"></div>

        <div class="flex items-center justify-between mt-4 gap-3">
          <div class="text-sm" id="pageInfo" style="color:var(--muted)">Page 1 of 1</div>
          <div class="flex gap-2">
            <button id="prevPage" class="px-3 py-1.5 rounded-2xl border hover:opacity-90" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Prev</button>
            <button id="nextPage" class="px-3 py-1.5 rounded-2xl border hover:opacity-90" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Next</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="donorModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="absolute inset-0 bg-black/60" data-close="true"></div>
    <div class="relative max-w-xl mx-auto mt-20 glass rounded-2xl shadow-soft p-6 border border-white/10" role="document">
      <div class="flex items-center justify-between">
        <h3 id="modalTitle" class="text-lg font-semibold">Add Customer</h3>
        <button class="p-2 rounded-2xl hover:opacity-80" id="modalClose" aria-label="Close modal">âœ•</button>
      </div>

      <form id="donorForm" class="grid grid-cols-1 gap-3 mt-4" novalidate>
        <input type="hidden" id="donorId" />
        <div>
          <label class="block text-sm">Company Name <span class="text-[var(--secondary)]">*</span></label>
          <input id="company" type="text" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)" required />
          <p id="errCompany" class="text-xs text-red-400 hidden">Company name is required.</p>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Contact Name <span class="text-[var(--secondary)]">*</span></label>
            <input id="contact" type="text" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)" required />
            <p id="errContact" class="text-xs text-red-400 hidden">Contact name is required.</p>
          </div>
          <div>
            <label class="block text-sm">Contact Phone <span class="text-[var(--secondary)]">*</span></label>
            <input id="phone" type="tel" inputmode="tel" pattern="^\+?[\d\s().-]{7,}$" placeholder="e.g. 555-123-4567" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)" required />
            <p id="errPhone" class="text-xs text-red-400 hidden">Enter a valid phone number.</p>
          </div>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Contact Email <span class="text-[var(--secondary)]">*</span></label>
            <input id="email" type="email" pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$" placeholder="name@example.com" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)" required />
            <p id="errEmail" class="text-xs text-red-400 hidden">Enter a valid email address.</p>
          </div>
          <div>
            <label class="block text-sm">Amount Paid ($) <span class="text-[var(--secondary)]">*</span></label>
            <input id="amount" type="number" min="0.01" step="0.01" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)" required />
            <p id="errAmount" class="text-xs text-red-400 hidden">Amount must be greater than 0.</p>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Status</label>
            <select id="status" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)">
              <option>Paid</option><option>Pledged</option><option>Invoiced</option>
            </select>
          </div>
          <div>
            <label class="block text-sm">Next Contact Date</label>
            <input id="next_contact" type="date" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)">
          </div>
        </div>

        <div>
          <label class="block text-sm">Company Address (optional)</label>
          <textarea id="address" rows="2" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)"></textarea>
        </div>

        <div>
          <label class="block text-sm">Notes</label>
          <textarea id="notes" rows="3" placeholder="e.g., sponsorship preferences, last conversation summaryâ€¦" class="mt-1 w-full rounded-2xl border border-white/15 bg-white/5 px-3 py-2" style="color:var(--text)"></textarea>
        </div>

        <div class="flex items-center justify-end gap-2 mt-2">
          <button type="button" id="btnDeleteInline" class="hidden px-3 py-2 rounded-2xl bg-red-600 text-white">Delete</button>
          <button type="button" id="btnPdfInline" class="hidden px-3 py-2 rounded-2xl border hover:opacity-90" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Download PDF</button>
          <button type="button" id="btnCancel" class="px-3 py-2 rounded-2xl border hover:opacity-90" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Cancel</button>
          <button type="submit" id="btnSubmit" class="px-3 py-2 rounded-2xl bg-[var(--primary)] text-white disabled:opacity-50 shadow-glow">Save Customer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastRegion" class="fixed bottom-4 right-4 flex flex-col gap-2 z-50" role="status" aria-live="polite"></div>

  <!-- Install banner -->
  <div id="installBanner" class="fixed bottom-4 left-4 right-4 sm:right-auto sm:w-[28rem] glass rounded-2xl p-4 border hidden z-50">
    <div class="flex items-start gap-3">
      <div class="text-xl">ðŸ“²</div>
      <div class="grow">
        <div class="font-semibold">Install this app</div>
        <div class="text-sm" style="color:var(--muted)">Works offline and from your home screen.</div>
      </div>
      <div class="flex gap-2">
        <button id="btnInstall" class="px-3 py-1.5 rounded-lg bg-[var(--primary)] text-white">Install</button>
        <button id="btnDismissInstall" class="px-3 py-1.5 rounded-lg border" style="background:transparent; border-color:var(--panel-border); color:var(--text)">Not now</button>
      </div>
    </div>
  </div>

  <!-- Update-available banner -->
  <div id="updateBanner" class="fixed top-4 right-4 glass rounded-2xl p-3 border hidden z-50">
    <div class="flex items-center gap-3">
      <span>Update available</span>
      <button id="btnReload" class="px-3 py-1.5 rounded-lg bg-[var(--primary)] text-white">Reload</button>
    </div>
  </div>

  <script>
    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmtMoney = (n) => (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD'});
    const todayStr = () => new Date().toISOString().slice(0,10);
    const uid = () => Math.random().toString(36).slice(2,9);
    const debounce = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
    const safeSlug = (s='') => String(s).trim().replace(/[^a-z0-9]+/gi,'_').replace(/^_+|_+$/g,'');
    const nowDate = () => new Date().toISOString().slice(0,10);
    const allCustomersPdfFilename = () => `Customers_Report_${nowDate()}.pdf`;
    const parseMoney = (v) => { const n = parseFloat(String(v ?? '').replace(/[^0-9.\-]/g,'')); return isNaN(n) ? 0 : n; };
    function toast(msg, type='success') {
      const wrap = document.createElement('div');
      wrap.className = `rounded-2xl px-4 py-3 text-sm text-white border ${type==='error' ? 'bg-red-600/90 border-red-400/40' : 'bg-[var(--primary)]/90 border-white/10'}`;
      wrap.setAttribute('role','alert'); wrap.textContent = msg;
      $('#toastRegion').appendChild(wrap);
      setTimeout(()=>{ wrap.classList.add('opacity-0','translate-y-1','transition'); setTimeout(()=>wrap.remove(),300); }, 2200);
    }
    function download(filename, text) {
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([text], {type: 'text/plain'})); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
    }
    const LS_KEYS = { donors: 'ffs_donors_v1', goal: 'ffs_goal_v1', badgeShown: 'ffs_badge_once', logo: 'ffs_logo_b64', theme:'ffs_theme', migrated:'ffs_migrated_v1', install_dismiss:'ffs_install_dismiss' };
    let IDB_OK = true; const DB_NAME = 'ffs_db_v1', STORE_CUSTOMERS='customers', STORE_META='meta';
    function idbOpen(){ return new Promise((resolve)=>{
      if (!('indexedDB' in window)) { IDB_OK=false; return resolve(null); }
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = (e)=>{ const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_CUSTOMERS)) db.createObjectStore(STORE_CUSTOMERS, { keyPath:'id' });
        if (!db.objectStoreNames.contains(STORE_META)) db.createObjectStore(STORE_META, { keyPath:'key' });
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> { IDB_OK=false; resolve(null); };
    });}
    const idbStore = (db, name, mode='readonly') => db.transaction(name, mode).objectStore(name);
    async function idbGetAll(name){
      const db = await idbOpen(); if (!db) return null;
      return new Promise((resolve)=>{ const out=[]; const req = idbStore(db,name).openCursor();
        req.onsuccess=(e)=>{ const c=e.target.result; if(c){ out.push(c.value); c.continue(); } else resolve(out); };
        req.onerror=()=> resolve(null);
      });
    }
    async function idbBulkReplaceCustomers(arr){
      const db = await idbOpen(); if (!db) return false;
      return new Promise((resolve)=>{
        const tx = db.transaction(STORE_CUSTOMERS,'readwrite'); const os = tx.objectStore(STORE_CUSTOMERS);
        os.clear().onsuccess = ()=>{
          if (!arr.length) return resolve(true);
          let left = arr.length; arr.forEach(v=>{ const r=os.put(v); r.onsuccess=()=>{ if(--left===0) resolve(true); }; r.onerror=()=>{{}}; });
        };
        tx.onerror=()=> resolve(false);
      });
    }
    async function idbGetMeta(key, fallback=null){
      const db = await idbOpen(); if(!db) return fallback;
      return new Promise((resolve)=>{ const r=idbStore(db,STORE_META).get(key); r.onsuccess=()=>resolve((r.result||{}).value ?? fallback); r.onerror=()=>resolve(fallback); });
    }
    async function idbSetMeta(key, value){
      const db = await idbOpen(); if(!db) return false;
      return new Promise((resolve)=>{ const r=idbStore(db,STORE_META,'readwrite').put({key,value}); r.onsuccess=()=>resolve(true); r.onerror=()=>resolve(false); });
    }
    async function migrateIfNeeded(){
      if (!IDB_OK) return;
      if (localStorage.getItem(LS_KEYS.migrated)) return;
      let legacy = []; try{ legacy = JSON.parse(localStorage.getItem(LS_KEYS.donors)) || []; }catch{}
      if (legacy.length) await idbBulkReplaceCustomers(legacy);
      const legacyGoal = Number(localStorage.getItem(LS_KEYS.goal)||0);
      await idbSetMeta('goal', legacyGoal);
      localStorage.setItem(LS_KEYS.migrated,'1');
    }
    async function loadCustomers(){ if (IDB_OK){ const a = await idbGetAll(STORE_CUSTOMERS); if (Array.isArray(a)) return a; } try{ return JSON.parse(localStorage.getItem(LS_KEYS.donors)) || []; }catch{ return []; } }
    function saveCustomers(arr){ if (IDB_OK) idbBulkReplaceCustomers(arr); else localStorage.setItem(LS_KEYS.donors, JSON.stringify(arr)); }
    async function loadGoalMeta(){ if (IDB_OK) return Number(await idbGetMeta('goal',0)) || 0; return Number(localStorage.getItem(LS_KEYS.goal)||0); }
    const _saveGoalDebounced = debounce((v)=>{ if (IDB_OK) idbSetMeta('goal', v); else localStorage.setItem(LS_KEYS.goal, String(Number(v)||0)); }, 400);
    const saveGoal = (v)=> _saveGoalDebounced(Number(v)||0);
    const loadLogo = ()=> localStorage.getItem(LS_KEYS.logo) || '';
    const saveLogo = (b64)=> localStorage.setItem(LS_KEYS.logo, b64 || '');
    const loadTheme = ()=> localStorage.getItem(LS_KEYS.theme) || 'dark';
    const saveTheme = (t)=> localStorage.setItem(LS_KEYS.theme, t);
    let customers = []; let goal = 0; let sortBy = null, sortDir = 1; const PAGE_SIZE = 10; let page = 1; let search = '';
    let PDF_LOGO = ''; let statusFilter = 'all'; let dateFilter = { mode: 'all', start: null, end: null };
    function applyTheme(t){ document.body.classList.toggle('theme-light', t==='light'); }
    function setDateFilter(mode){
      const now = new Date(); const y = now.getFullYear(), m = now.getMonth();
      const startOfMonth = new Date(y, m, 1); const startOfLastMonth = new Date(y, m-1, 1); const endOfLastMonth = new Date(y, m, 0); const startOfYear = new Date(y, 0, 1);
      dateFilter.mode = mode;
      if (mode === 'this_month'){ dateFilter.start = startOfMonth; dateFilter.end = null; }
      else if (mode === 'last_month'){ dateFilter.start = startOfLastMonth; dateFilter.end = new Date(endOfLastMonth.getFullYear(), endOfLastMonth.getMonth(), endOfLastMonth.getDate()+1); }
      else if (mode === 'ytd'){ dateFilter.start = startOfYear; dateFilter.end = null; }
      else { dateFilter.start = null; dateFilter.end = null; }
    }
    function dateInRange(iso){
      if (!iso) return true; const d = new Date(iso); if (isNaN(+d)) return true;
      if (dateFilter.start && d < dateFilter.start) return false;
      if (dateFilter.end && d >= dateFilter.end) return false; return true;
    }
    const CIRCUM = 2 * Math.PI * 54;
    function setMainProgress(pct){
      const ring = document.getElementById('ringProgress');
      ring.setAttribute('stroke-dasharray', CIRCUM.toFixed(3));
      ring.setAttribute('stroke-dashoffset', (CIRCUM * (1 - Math.max(0, Math.min(1, pct)))).toFixed(3));
      ring.setAttribute('stroke', 'var(--ring)');
    }
    function updateRing(){
      const raised = customers.reduce((sum,d)=> sum + Number(d.amount||0), 0);
      const newPct = (goal>0) ? Math.min(raised/goal, 1) : 0;
      setMainProgress(newPct);
      const badge = document.getElementById('ringBadge');
      if (goal>0 && raised >= goal){
        if (!localStorage.getItem(LS_KEYS.badgeShown)){
          badge.classList.remove('hidden'); badge.classList.add('animate-pulseonce');
          localStorage.setItem(LS_KEYS.badgeShown, '1'); setTimeout(()=>badge.classList.remove('animate-pulseonce'), 800);
        } else { badge.classList.remove('hidden'); }
      } else { badge.classList.add('hidden'); }
      document.getElementById('raisedText').textContent = fmtMoney(raised);
      document.getElementById('percentText').textContent = `${goal>0? Math.round(newPct*100):0}% of ${fmtMoney(goal)}`;
    }
    function updateStatusFilterUI(){
      $$('#statusFilters [data-sf]').forEach(btn=>{
        const active = btn.getAttribute('data-sf') === statusFilter;
        btn.className = 'px-2 py-1 rounded-lg border ' + (active ? 'bg-[var(--primary)]/25 border-[var(--primary)]/60' : 'bg-transparent border-white/15');
      });
    }
    function updateDateFilterUI(){
      $$('#dateFilters [data-df]').forEach(btn=>{
        const active = btn.getAttribute('data-df') === dateFilter.mode;
        btn.className = 'px-2 py-1 rounded-lg border ' + (active ? 'bg-[var(--primary)]/25 border-[var(--primary)]/60' : 'bg-transparent border-white/15');
      });
    }
    document.addEventListener('click', (e)=>{
      const v = e.target.getAttribute?.('data-sf'); if (v){ statusFilter = v; updateStatusFilterUI(); page = 1; render(); }
      const df = e.target.getAttribute?.('data-df'); if (df){ setDateFilter(df); updateDateFilterUI(); page = 1; render(); }
    });
    function statusPillClass(s){
      switch((s||'Paid')){
        case 'Pledged': return 'bg-amber-500/20 text-amber-300 border border-amber-500/30';
        case 'Invoiced': return 'bg-sky-500/20 text-sky-300 border border-sky-500/30';
        default: return 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30';
      }
    }
    function duePill(d){
      const iso = d.next_contact; if (!iso) return '';
      const today = new Date(); today.setHours(0,0,0,0);
      const dt = new Date(iso); if (isNaN(+dt)) return '';
      const days = Math.floor((dt - today)/86400000);
      if (days < 0) return `<span class="ml-2 px-2 py-0.5 rounded-lg text-xs bg-red-500/20 text-red-200 border border-red-500/30">Overdue</span>`;
      if (days <= 7) return `<span class="ml-2 px-2 py-0.5 rounded-lg text-xs bg-amber-500/20 text-amber-200 border border-amber-500/30">Due soon</span>`;
      return '';
    }
    function filteredSorted(){
      let arr = customers.filter(d=>{
        if (statusFilter!=='all' && (d.status||'Paid') !== statusFilter) return false;
        if (!dateInRange(d.date)) return false;
        if(!search) return true; const t = (d.company+" "+d.contact+" "+d.email).toLowerCase();
        return t.includes(search.toLowerCase());
      });
      if (sortBy){
        arr.sort((a,b)=>{
          let av = sortBy==='amount'? Number(a.amount) : (a.company||'');
          let bv = sortBy==='amount'? Number(b.amount) : (b.company||'');
          if (av<bv) return -1*sortDir; if (av>bv) return  1*sortDir; return 0;
        });
      }
      return arr;
    }
    function updateSubtotal(arr){
      const total = arr.reduce((s,d)=> s + Number(d.amount||0), 0);
      const count = arr.length;
      document.getElementById('subtotalBar').textContent = `Showing ${count} ${count===1?'customer':'customers'} â€¢ Subtotal: ${fmtMoney(total)}`;
    }
    function render(){
      document.getElementById('goalInput').value = goal || '';
      updateRing(); updateStatusFilterUI(); updateDateFilterUI();
      const arr = filteredSorted(); updateSubtotal(arr);
      const totalPages = Math.max(1, Math.ceil(arr.length / PAGE_SIZE));
      page = Math.min(page, totalPages);
      document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;
      const start = (page-1)*PAGE_SIZE;
      const rows = arr.slice(start, start+PAGE_SIZE);
      const tbody = document.getElementById('donorTbody'); tbody.innerHTML = '';
      for (const d of rows){
        const tr = document.createElement('tr'); tr.className = 'border-b border-white/10 last:border-0';
        tr.innerHTML = `
          <td class="px-3 py-2">${escapeHtml(d.company)}</td>
          <td class="px-3 py-2">${escapeHtml(d.contact)}</td>
          <td class="px-3 py-2"><a href="tel:${encodeURIComponent(d.phone)}" class="underline decoration-dotted">${escapeHtml(d.phone)}</a></td>
          <td class="px-3 py-2"><a href="mailto:${encodeURIComponent(d.email)}" class="underline decoration-dotted">${escapeHtml(d.email)}</a></td>
          <td class="px-3 py-2">${fmtMoney(d.amount)}</td>
          <td class="px-3 py-2">${d.date||''}</td>
          <td class="px-3 py-2">
            <span class="px-2 py-0.5 rounded-lg text-xs ${statusPillClass(d.status)}">${d.status||'Paid'}</span>
            ${duePill(d)}
          </td>
          <td class="px-3 py-2 flex gap-2">
            <button class="px-2 py-1 rounded-lg border hover:opacity-90" style="background:transparent; border-color:var(--panel-border); color:var(--text)" data-edit="${d.id}">Edit</button>
            <button class="px-2 py-1 rounded-lg border hover:opacity-90" style="background:transparent; border-color:var(--panel-border); color:var(--text)" data-del="${d.id}">Delete</button>
            <button class="px-2 py-1 rounded-lg bg-[var(--primary)] text-white" data-pdf="${d.id}">PDF</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    const modal = document.getElementById('donorModal');
    const form = document.getElementById('donorForm');
    const submitBtn = document.getElementById('btnSubmit');
    function openModal(mode, rec=null){
      document.body.classList.add('modal-open'); modal.classList.remove('hidden');
      document.getElementById('modalTitle').textContent = mode==='edit'? 'Edit Customer' : 'Add Customer';
      const isEdit = mode==='edit';
      document.getElementById('btnDeleteInline').classList.toggle('hidden', !isEdit);
      document.getElementById('btnPdfInline').classList.toggle('hidden', !isEdit);
      if (isEdit && rec){
        document.getElementById('donorId').value = rec.id;
        document.getElementById('company').value = rec.company || '';
        document.getElementById('contact').value = rec.contact || '';
        document.getElementById('phone').value = rec.phone || '';
        document.getElementById('email').value = rec.email || '';
        document.getElementById('amount').value = Number(rec.amount||0).toFixed(2);
        document.getElementById('status').value = rec.status || 'Paid';
        document.getElementById('next_contact').value = rec.next_contact || '';
        document.getElementById('address').value = rec.address||'';
        document.getElementById('notes').value = rec.notes||'';
      } else {
        form.reset(); document.getElementById('donorId').value='';
        document.getElementById('status').value = 'Paid';
        document.getElementById('next_contact').value = '';
        document.getElementById('notes').value = '';
      }
      validateForm(); setTimeout(()=>document.getElementById('company').focus(), 20);
    }
    function closeModal(){ modal.classList.add('hidden'); document.body.classList.remove('modal-open'); }
    document.getElementById('btnAddDonor').addEventListener('click', ()=> openModal('add'));
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('btnCancel').addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if (e.target.dataset.close==='true') closeModal(); });
    window.addEventListener('keydown', (e)=>{ if (!modal.classList.contains('hidden') && e.key==='Escape') closeModal(); });
    function validateForm(){
      const company = document.getElementById('company');
      const contact = document.getElementById('contact');
      const phone = document.getElementById('phone');
      const email = document.getElementById('email');
      const amount = document.getElementById('amount');
      const vCompany = company.value.trim().length>0;
      const vContact = contact.value.trim().length>0;
      const vPhone = (/^\+?[\d\s().-]{7,}$/).test(phone.value.trim());
      const vEmail = (/^[^\s@]+@[^\s@]+\.[^\s@]+$/).test(email.value.trim());
      const vAmount = Number(parseMoney(amount.value)) > 0;
      document.getElementById('errCompany').classList.toggle('hidden', vCompany);
      document.getElementById('errContact').classList.toggle('hidden', vContact);
      document.getElementById('errPhone').classList.toggle('hidden', vPhone);
      document.getElementById('errEmail').classList.toggle('hidden', vEmail);
      document.getElementById('errAmount').classList.toggle('hidden', vAmount);
      submitBtn.disabled = !(vCompany && vContact && vPhone && vEmail && vAmount);
      return !submitBtn.disabled;
    }
    ['input','change','blur'].forEach(ev=> form.addEventListener(ev, validateForm));
    function isDuplicate({id, company, contact, email}){
      const c = String(company||'').toLowerCase().trim();
      const p = String(contact||'').toLowerCase().trim();
      const e = String(email||'').toLowerCase().trim();
      return customers.some(d=>{
        if (d.id === id) return false;
        const dc = String(d.company||'').toLowerCase().trim();
        const dp = String(d.contact||'').toLowerCase().trim();
        const de = String(d.email||'').toLowerCase().trim();
        return de === e || (dc === c && dp === p);
      });
    }
    form.addEventListener('submit', (e)=>{
      e.preventDefault(); if(!validateForm()) return;
      const id = document.getElementById('donorId').value || uid();
      const rec = {
        id, company: document.getElementById('company').value.trim(),
        contact: document.getElementById('contact').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        amount: parseMoney(document.getElementById('amount').value),
        status: document.getElementById('status').value || 'Paid',
        next_contact: document.getElementById('next_contact').value || '',
        address: document.getElementById('address').value.trim(),
        notes: document.getElementById('notes').value.trim(),
        date: document.getElementById('donorId').value ? (customers.find(d=>d.id===id)?.date || todayStr()) : todayStr()
      };
      if (isDuplicate(rec)){ const ok = confirm('Possible duplicate customer detected (same email or same company+contact). Save anyway?'); if (!ok) return; }
      const idx = customers.findIndex(d=>d.id===id);
      if (idx>=0) customers[idx]=rec; else customers.unshift(rec);
      saveCustomers(customers); toast(idx>=0? 'Customer updated' : 'Customer added'); closeModal(); render();
    });
    function deleteCustomer(id){
      const i = customers.findIndex(d=>d.id===id); if (i<0) return;
      const last = customers[i]; customers.splice(i,1);
      saveCustomers(customers); render();
      const wrap = document.createElement('div');
      wrap.className = 'rounded-2xl px-4 py-3 text-sm text-white border bg-red-600/90 border-red-400/40';
      wrap.innerHTML = `Customer deleted. <button id="undoDel" class="underline ml-2">Undo</button>`;
      document.getElementById('toastRegion').appendChild(wrap);
      const t = setTimeout(()=>wrap.remove(), 4000);
      wrap.querySelector('#undoDel').onclick = ()=>{ clearTimeout(t); if (last){ customers.unshift(last); saveCustomers(customers); render(); } wrap.remove(); };
    }
    document.getElementById('btnDeleteInline').addEventListener('click', ()=>{ const id = document.getElementById('donorId').value; if(!id) return; deleteCustomer(id); closeModal(); });
    document.getElementById('btnPdfInline').addEventListener('click', ()=>{ const id = document.getElementById('donorId').value; if(!id) return; const d = customers.find(x=>x.id===id); if (d) exportSingleCustomerPDF(d); });
    document.getElementById('donorTbody').addEventListener('click', (e)=>{
      const id = e.target.getAttribute('data-edit') || e.target.getAttribute('data-del') || e.target.getAttribute('data-pdf');
      if (!id) return; const rec = customers.find(d=>d.id===id);
      if (e.target.hasAttribute('data-edit')){ openModal('edit', rec); }
      if (e.target.hasAttribute('data-del')){ deleteCustomer(id); }
      if (e.target.hasAttribute('data-pdf')){ exportSingleCustomerPDF(rec); }
    });
    document.getElementById('searchInput').addEventListener('input', (e)=>{ search = e.target.value; page=1; render(); });
    function toggleSort(field){
      if (sortBy!==field){ sortBy=field; sortDir=1; } else { sortDir *= -1; }
      document.getElementById('iconSortCompany').textContent = sortBy==='company' ? (sortDir>0?'â†‘':'â†“') : 'â‡…';
      document.getElementById('iconSortAmount').textContent = sortBy==='amount' ? (sortDir>0?'â†‘':'â†“') : 'â‡…';
      render();
    }
    document.getElementById('thCompany').addEventListener('click', ()=> toggleSort('company'));
    document.getElementById('thAmount').addEventListener('click', ()=> toggleSort('amount'));
    document.getElementById('prevPage').addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
    document.getElementById('nextPage').addEventListener('click', ()=>{ const total = Math.max(1, Math.ceil(filteredSorted().length / PAGE_SIZE)); if(page<total){ page++; render(); }});
    document.getElementById('goalInput').addEventListener('input', (e)=>{ goal = Number(e.target.value)||0; saveGoal(goal); localStorage.removeItem(LS_KEYS.badgeShown); updateRing(); });
    document.getElementById('demoToggle').addEventListener('change', (e)=>{
      if (e.target.checked){
        customers = [
          {id:uid(), company:'Acme Co', contact:'Sam Jones', phone:'513-555-1122', email:'sam@acme.com', address:'100 Main St, Cincinnati, OH', amount:500,  status:'Paid',     next_contact: todayStr(), notes:'Annual sponsor', date: todayStr()},
          {id:uid(), company:'RiverTech', contact:'Dana Wu', phone:'513-555-9876', email:'dana@river.tech', address:'22 Vine St, Cincinnati, OH', amount:1250, status:'Invoiced', next_contact: '',       notes:'Prefers email',  date: todayStr()},
          {id:uid(), company:'Green City Bikes', contact:'Luis Gomez', phone:'513-555-2222', email:'luis@gcbikes.org', address:'77 Elm St', amount:200,  status:'Pledged',  next_contact: todayStr(), notes:'Ask about bronze package', date: todayStr()},
        ];
        saveCustomers(customers); toast('Demo customers loaded'); render();
        if (!goal){ goal = 3000; saveGoal(goal); render(); }
      } else {
        customers = []; saveCustomers(customers); toast('Demo cleared'); render();
      }
    });
    function customersToCsvFiltered(){
      const headers = ['company','contact','phone','email','amount','date','status','next_contact','address','notes'];
      const arr = filteredSorted();
      const rows = arr.map(d => headers.map(h => `"${String(d[h]??'').replace(/"/g,'""')}"`).join(','));
      return headers.join(',') + '\n' + rows.join('\n');
    }
    document.getElementById('btnExportCsv').addEventListener('click', ()=> download(`customers_filtered_${nowDate()}.csv`, customersToCsvFiltered()));
    document.getElementById('importCsv').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return; const text = await file.text();
      const lines = text.split(/\r?\n/).filter(Boolean);
      const headers = lines.shift().split(',').map(h=>h.replace(/^"|"$/g,''));
      const req = ['company','contact','phone','email','amount'];
      const hasReq = req.every(r=> headers.includes(r));
      if (!hasReq){ toast('CSV missing required headers','error'); return; }
      let added=0, skipped=0;
      for (const line of lines){
        const cols = parseCsvLine(line);
        const obj = Object.fromEntries(headers.map((h,i)=> [h, cols[i]??'']));
        if (validateCsvRow(obj)){
          customers.unshift({
            id: uid(), company: obj.company, contact: obj.contact, phone: obj.phone, email: obj.email,
            amount: Number(obj.amount), date: obj.date || todayStr(), status: obj.status || 'Paid',
            next_contact: obj.next_contact || '', address: obj.address||'', notes: obj.notes||'',
          });
          added++;
        } else skipped++;
      }
      saveCustomers(customers); render();
      const msg = `CSV import: added ${added}, skipped ${skipped}`;
      const summary = document.getElementById('importSummary'); summary.classList.remove('hidden'); summary.textContent = msg;
      toast(msg, skipped? 'error':'success'); e.target.value = '';
    });
    function parseCsvLine(line){
      const out = []; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){
        const ch=line[i];
        if (inQ){
          if (ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
          else if (ch=== '"'){ inQ=false; }
          else cur+=ch;
        } else {
          if (ch === '"'){ inQ=true; }
          else if (ch === ','){ out.push(cur); cur=''; }
          else cur+=ch;
        }
      }
      out.push(cur); return out;
    }
    function validateCsvRow(o){
      const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const phoneRe = /^\+?[\d\s().-]{7,}$/;
      return o.company && o.contact && phoneRe.test(o.phone||'') && emailRe.test(o.email||'') && Number(o.amount)>0;
    }
    document.getElementById('btnBackupJson').addEventListener('click', ()=>{
      const payload = { version:1, goal, customers };
      download('ffs_backup.json', JSON.stringify(payload, null, 2));
    });
    document.getElementById('restoreJson').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return; const text = await file.text();
      try {
        const data = JSON.parse(text);
        if (!data || typeof data !== 'object' || !Array.isArray(data.customers||data.donors)) throw new Error('Bad schema');
        const arr = data.customers || data.donors;
        for (const d of arr){ if (!d.id) d.id=uid(); d.amount=Number(d.amount)||0; }
        customers = arr; goal = Number(data.goal)||0;
        saveCustomers(customers); saveGoal(goal); localStorage.removeItem(LS_KEYS.badgeShown);
        toast('Backup restored'); render();
      } catch(err){ toast('Restore failed: '+err.message,'error'); }
      e.target.value='';
    });
    document.getElementById('btnReset').addEventListener('click', ()=>{
      const inp = prompt('Type RESET to clear all data.');
      if (inp==='RESET'){
        localStorage.removeItem(LS_KEYS.donors);
        localStorage.removeItem(LS_KEYS.goal);
        localStorage.removeItem(LS_KEYS.badgeShown);
        localStorage.removeItem(LS_KEYS.logo);
        customers=[]; goal=0; render(); toast('App reset');
      }
    });
    function drawPdfHeader(doc, title){
      const pageW = doc.internal.pageSize.getWidth();
      let y = 24;
      if (PDF_LOGO){
        const maxH = 50;
        const imgW = 200, imgH = 200;
        const scale = maxH / imgH;
        const w = imgW * scale, h = imgH * scale;
        const x = (pageW - w) / 2;
        try{ doc.addImage(PDF_LOGO, 'PNG', x, y, w, h); }catch(e){}
        y += h + 6;
      }
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text(title, pageW/2, y, {align:'center'}); y += 10;
      doc.setDrawColor(200); doc.line(40, y, pageW-40, y); y += 16;
      return y;
    }
    function exportSingleCustomerPDF(d){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'letter' });
      let y = drawPdfHeader(doc, 'Customer Summary');
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Details', 56, y); y+=14; doc.setFont('helvetica','normal'); doc.setFontSize(11);
      const rows = [
        ['Company', d.company], ['Contact', d.contact], ['Phone', d.phone], ['Email', d.email],
        ['Amount Paid', fmtMoney(d.amount)], ['Status', d.status||''], ['Next Contact', d.next_contact||''],
        ['Date', d.date||''], ['Address', d.address||''],
      ];
      rows.forEach(([k,v])=>{ doc.setFont('helvetica','bold'); doc.text(`${k}:`, 56, y);
        doc.setFont('helvetica','normal'); doc.text(String(v||''), 56+120, y, {maxWidth: 612 - 56*2 - 120}); y+=18; });
      if (d.notes){
        y+=8; doc.setFont('helvetica','bold'); doc.text('Notes', 56, y); y+=12;
        doc.setFont('helvetica','normal'); const maxWidth = 612-56*2;
        const lines = doc.splitTextToSize(String(d.notes), maxWidth);
        doc.text(lines, 56, y); y += lines.length*14;
      }
      const pageCount = doc.getNumberOfPages();
      for(let i=1;i<=pageCount;i++){ doc.setPage(i); doc.setFontSize(10); doc.text(`Page ${i} of ${pageCount}`, 612/2, 760, {align:'center'}); }
      doc.save(`customer_${safeSlug(d.company||'')}.pdf`);
    }
    function exportAllCustomersPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'letter' });
      let y = drawPdfHeader(doc, 'Customers Report');
      const arr = filteredSorted(); const raised = arr.reduce((s,d)=> s + Number(d.amount||0),0);
      const percent = goal>0? Math.round(raised/goal*100):0;
      doc.setFont('helvetica','normal'); doc.setFontSize(12);
      doc.text(`Goal: ${fmtMoney(goal)}`, 40, y); y+=18;
      doc.text(`Filtered Total Raised: ${fmtMoney(raised)}  (${percent}% of goal)`, 40, y); y+=18;
      doc.text(`Records: ${arr.length}`, 40, y); y+=24;
      const cols = ['Company','Contact','Email','Amount','Date','Status','Next'];
      const widths = [150,110,130,70,60,70,60];
      doc.setFont('helvetica','bold'); doc.setFontSize(11);
      let x = 40; for(let i=0;i<cols.length;i++){ doc.text(cols[i], x, y); x+=widths[i]; }
      y+=12; doc.setDrawColor(200); doc.line(40,y,612-40,y); y+=8; doc.setFont('helvetica','normal');
      const lineH = 14; const maxY = 740;
      arr.forEach(d=>{
        const row = [d.company, d.contact, d.email, fmtMoney(d.amount), d.date||'', d.status||'', d.next_contact||''];
        x = 40; for(let i=0;i<row.length;i++){ doc.text(String(row[i]||''), x, y, {maxWidth: widths[i]-6}); x+=widths[i]; }
        y+=lineH; if (y>maxY){ doc.addPage(); y = drawPdfHeader(doc, 'Customers Report'); }
      });
      const pageCount = doc.getNumberOfPages();
      for(let i=1;i<=pageCount;i++){ doc.setPage(i); doc.setFontSize(10); doc.text(`Page ${i} of ${pageCount}`, 612/2, 760, {align:'center'}); }
      doc.save(allCustomersPdfFilename());
    }
    document.getElementById('btnAllDonorsPdf').addEventListener('click', exportAllCustomersPDF);
    const logoPreview = document.getElementById('logoPreview');
    const logoStatus = document.getElementById('logoStatus');
    document.getElementById('logoUpload').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const b64 = await fileToBase64(file);
      PDF_LOGO = b64; saveLogo(b64);
      logoPreview.src = b64; logoPreview.classList.remove('hidden');
      logoStatus.textContent = 'Logo set.'; toast('Logo saved for PDFs');
    });
    document.getElementById('btnClearLogo').addEventListener('click', ()=>{
      PDF_LOGO = ''; saveLogo(''); logoPreview.src=''; logoPreview.classList.add('hidden'); logoStatus.textContent = 'No logo set.'; toast('Logo cleared');
    });
    function fileToBase64(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    document.getElementById('btnTheme').addEventListener('click', ()=>{ const now = document.body.classList.contains('theme-light') ? 'dark' : 'light'; applyTheme(now); saveTheme(now); });
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e;
      if (!localStorage.getItem(LS_KEYS.install_dismiss)){ document.getElementById('installBanner').classList.remove('hidden'); }
    });
    document.getElementById('btnInstall').addEventListener('click', async ()=>{
      if (!deferredPrompt) return;
      document.getElementById('installBanner').classList.add('hidden');
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null;
    });
    document.getElementById('btnDismissInstall').addEventListener('click', ()=>{
      localStorage.setItem(LS_KEYS.install_dismiss,'1');
      document.getElementById('installBanner').classList.add('hidden');
    });
    async function registerSW(){
      if (!('serviceWorker' in navigator)) return;
      try {
        const reg = await navigator.serviceWorker.register('service-worker.js');
        if (reg.waiting) showUpdate(reg.waiting);
        reg.addEventListener('updatefound', ()=>{
          const nw = reg.installing;
          nw?.addEventListener('statechange', ()=>{
            if (nw.state === 'installed' && navigator.serviceWorker.controller){ showUpdate(nw); }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', ()=> location.reload());
      } catch(e){}
    }
    function showUpdate(sw){
      const banner = document.getElementById('updateBanner'); banner.classList.remove('hidden');
      document.getElementById('btnReload').onclick = ()=> sw.postMessage({type:'SKIP_WAITING'});
    }
    function runTests(){
      try{
        console.group('App Tests');
        console.assert(parseMoney('12') === 12, 'parseMoney integer');
        console.assert(parseMoney('$1,234.50') === 1234.5, 'parseMoney currency');
        console.assert(parseMoney('') === 0, 'parseMoney empty -> 0');
        const sample = [
          {company:'B Co', amount:200, contact:'x', email:'a@a.com', phone:'1111111'},
          {company:'A Co', amount:100, contact:'y', email:'b@b.com', phone:'2222222'}
        ];
        const byCompany = sample.slice().sort((a,b)=> a.company.localeCompare(b.company));
        console.assert(byCompany[0].company === 'A Co', 'company sort asc');
        const byAmount = sample.slice().sort((a,b)=> a.amount - b.amount);
        console.assert(byAmount[0].amount === 100, 'amount sort asc');
        const ring = document.getElementById('ringProgress');
        console.assert(ring && ring.getAttribute('stroke') === 'var(--ring)', 'ring solid color');
        console.groupEnd();
      }catch(err){ console.error('Tests failed:', err); }
    }
    async function init(){
      applyTheme(loadTheme());
      await migrateIfNeeded();
      customers = await loadCustomers();
      goal = await loadGoalMeta();
      PDF_LOGO = loadLogo();
      if (PDF_LOGO){ logoPreview.src = PDF_LOGO; logoPreview.classList.remove('hidden'); logoStatus.textContent = 'Logo set.'; }
      render(); runTests(); registerSW();
      const amountEl = document.getElementById('amount');
      if (amountEl){
        amountEl.addEventListener('blur', ()=>{ const n = parseMoney(amountEl.value); amountEl.value = n.toFixed(2); validateForm(); });
        amountEl.addEventListener('change', ()=>{ const n = parseMoney(amountEl.value); amountEl.value = n.toFixed(2); validateForm(); });
      }
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
